<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cadastro</title>
    <link
      href="https://fonts.googleapis.com/css?family=Amiko"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="css/styleCadastro.css" />
    <link
      rel="shortcut icon"
      href="./img/logo.ico"
      type="image/x-icon"
    />
    <link href="toastr.css" rel="stylesheet"/>

  </head>

  <body>
    <div id="backgroundCadastro">
      
    </div>
  </body>
</html>
<script src="toastr.js"></script>
<script>
    toastr.options = {
    "closeButton": false,
    "debug": false,
    "newestOnTop": false,
    "progressBar": true,
    "positionClass": "toast-bottom-right",
    "preventDuplicates": false,
    "onclick": null,
    "showDuration": "300",
    "hideDuration": "1000",
    "timeOut": "3500",
    "extendedTimeOut": "1000",
    "showEasing": "swing",
    "hideEasing": "linear",
    "showMethod": "fadeIn",
    "hideMethod": "fadeOut"
  }

    $('#cpfUsuario').mask('000.000.000-00');
    carregarEmpresas()

function carregarEmpresas() {
    fetch(`/usuarios/mostrarEmpresas`).then(function (resposta) {
        if (resposta.ok) {

            resposta.json().then(function (resposta) {
                // console.log("Dados recebidos: ", JSON.stringify(resposta));
                infos = resposta

                for (let i = 0; i < resposta.length; i++) {
                  codEmpresa.innerHTML += `<option value="${resposta[i].idEmpresa}" >${resposta[i].nome}</option>`;
                }
            
            });
        } else {
            throw ('Houve um erro na API!');
        }
    }).catch(function (resposta) {
        console.error(resposta);

    });
}

  function registerUser() {
    var nomeVar = nomeUsuario.value;
    var cpfVar = cpfUsuario.value.replaceAll('.', '').replace('-', '');
    var codEmpresaVar = codEmpresa.value;
    var emailVar = emailUsuario.value; //Obrigatório
    var psswdVar = senhaUsuario.value; //Obrigatório
    var confPsswdVar = confSenha.value;

    var verif_blank =
      psswdVar == "" &&
      emailVar == "" &&
      confPsswdVar == "" &&
      nomeVar == "" &&
      cpfVar == "" &&
      codEmpresaVar == "";
    var verif_Psswd = psswdVar != confPsswdVar || confPsswdVar == "";
    var verif_emailUser = emailVar.indexOf("@") == -1 || emailVar == "";
    var verifCpf = cpfVar.length < 11;

    //Verificações
    if (verif_blank) {
      //Nenhum campo preenchido
      toastr.error("<b style='font-family: arial;'>Todos os campos estão vazios, preencha-os corretamente!</b>")
      return false;
    } else {
      if (verif_emailUser) {
        toastr.error("<b style='font-family: arial;'>O e-mail deve ser preenchido corretamente</b>")
        return false;
      }
      if (verifCpf) {
        toastr.error("<b style='font-family: arial;'>O CPF é inválido</b>")
        return false;
      }
      if (verif_Psswd) {
        toastr.error("<b style='font-family: arial;'>As senhas não correspondem!</b>")
        return false;
      }
    }
    // Enviando o valor da nova input
    fetch("/usuarios/cadastrar", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        nomeServer: nomeVar,
        cpfServer: cpfVar,
        empresaServer: codEmpresaVar,
        emailServer: emailVar,
        senhaServer: psswdVar,
      }),
    })
      .then(function (resposta) {
        console.log("resposta: ", resposta);

        if (resposta.ok) {
          alert("Cadastro realizado com sucesso! Redirecionando para o Login");

          setTimeout((window.location = "login.html"), 2000);
        } else {
          throw "Houve um erro ao tentar realizar o cadastro!";
        }
      })
      .catch(function (resposta) {
        console.log(`#ERRO: ${resposta}`);
      });

    return false;
  }
</script>
